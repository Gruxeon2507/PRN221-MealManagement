@page
@model Project.Pages.Schedule.UpdateMealModel
@{
}
@{
}
@using System.Text.Json
@using Project.Models
<style>
    table, th, td {
        border: 1px solid black;
    }
</style>
<h4>Update Meal</h4>
<form method="post">
    Choose your dish:
    <select id="recipes" name="recipes" class="form-select" multiple aria-label="multiple select example">
        @foreach (Recipe item in Model.Recipes)
        {
            bool checkRecipe = false;
            foreach(MealsRecipe mr in Model.Meal.MealsRecipes)
            {
                if(mr.RecipeId == item.Id)
                {
                    checkRecipe = true;
                    break;
                }
            }
            if (checkRecipe)
            {
                <option value="@item.Id" selected>@item.Name</option>
            }
            else
            {
                <option value="@item.Id">@item.Name</option>
            }

        }
    </select>
    <br />
    Message:
    <textarea name="message">@Model.Meal.Message</textarea>
    <input type="hidden" name="id" value="@Model.Meal.Id" />
    <button>Update Meal</button>
</form>
<button onclick="deleteMeal(@Model.Meal.Id)">Delete meal</button>
<a href="/Schedule/Index">Back to Calendar</a>
<p>@Model.Message</p>
<div id="recipeDetails"></div>
<script>
    $(document).ready(function () {
        var selectedRecipeId = $('#recipes').val();
        console.log(selectedRecipeId)
        let url = '/Schedule/CreateMeal?handler=RecipeDetails'
        selectedRecipeId.forEach(function (data, index) {
            url += '&recipeId=' + data;
        })
        console.log(url);
        if (selectedRecipeId) {
            // Make an AJAX request to fetch details of the selected recipe
            $.ajax({
                type: 'GET',
                url: url
                //'/Schedule/CreateMeal?handler=RecipeDetails'
                ,
                data: { recipeId: selectedRecipeId },
                success: function (response) {
                    console.log('/Schedule/CreateMeal?handler=RecipeDetails&recipeId=' + selectedRecipeId)
                    // Update the recipeDetails div with the fetched recipe details
                    console.log("Recipe details:", response);
                    var recipeDetailsElement = $('#recipeDetails');
                    if (recipeDetailsElement.length > 0) {
                        recipeDetailsElement.html(response);
                    } else {
                        console.error('Element #recipeDetails not found');
                    }
                    //$('#recipeDetails').html(response);
                },
                error: function (xhr, status, error) {
                    // Handle error if needed
                    console.error('Error:', error);
                }
            });
        } else {
            $('#recipeDetails').empty(); // Clear the recipeDetails div if no recipe is selected
        }
    });
   
    $('#recipes').change(function () {
        var selectedRecipeId = $(this).val();
        let url = '/Schedule/CreateMeal?handler=RecipeDetails'
        selectedRecipeId.forEach(function (data, index) {
            url += '&recipeId=' + data;
        })
        console.log(url);
        if (selectedRecipeId) {
            // Make an AJAX request to fetch details of the selected recipe
            $.ajax({
                type: 'GET',
                url: url
                //'/Schedule/CreateMeal?handler=RecipeDetails'
                ,
                data: { recipeId: selectedRecipeId },
                success: function (response) {
                    console.log('/Schedule/CreateMeal?handler=RecipeDetails&recipeId=' + selectedRecipeId)
                    // Update the recipeDetails div with the fetched recipe details
                    console.log("Recipe details:", response);
                    var recipeDetailsElement = $('#recipeDetails');
                    if (recipeDetailsElement.length > 0) {
                        recipeDetailsElement.html(response);
                    } else {
                        console.error('Element #recipeDetails not found');
                    }
                    //$('#recipeDetails').html(response);
                },
                error: function (xhr, status, error) {
                    // Handle error if needed
                    console.error('Error:', error);
                }
            });
        } else {
            $('#recipeDetails').empty(); // Clear the recipeDetails div if no recipe is selected
        }
    });

    function deleteMeal(mealId){
        let ok = confirm("Do you want to delete this meal");
        if(ok === true){
            $.ajax({
                type: 'GET',
                url: '/Schedule/DeleteMeal?mealId=' + mealId,
                data: { mealId: mealId },
                success: function (response) {
                    console.log('/Schedule/DeleteMeal?mealId=' + mealId)
                    // Update the recipeDetails div with the fetched recipe details
                    alert("Delete Successfully!")
                    location.href="/Schedule/Index";
                },
                error: function (xhr, status, error) {
                    // Handle error if needed
                    console.error('Error:', error);
                }
            });
        }
       
    }
</script>
